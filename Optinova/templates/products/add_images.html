{% extends "admin_page/main.html" %}
{% block title %}Add Images{% endblock %}

{% block content %}
<main class="main-wrap">
    <section class="content-main">
        <div class="content-header">
            <h2 class="content-title">Add Images for Variant: {{ variant.color }}</h2>
        </div>

        <div class="card mb-4">
            <div class="card-body">
                <input type="file" id="imageInput" accept="image/*" class="form-control" aria-label="Upload Image">
                <img id="imagePreview" alt="Image Preview" style="max-width: 300px; margin-top: 20px; display: none;">
                <button type="button" id="cropImageButton" style="margin-top: 10px; display: none;">Crop Image</button>
                <canvas id="croppedImageCanvas" style="display: none;"></canvas>

                <form id="uploadForm" method="POST">
                    {% csrf_token %}
                    <input type="hidden" id="croppedImageData" name="croppedImageData">
                    <button type="submit" style="margin-top: 10px;" disabled>Upload Cropped Image</button>
                </form>
            </div>
        </div>
    </section>
</main>

<!-- Include Cropper.js CSS and JS -->
<link href="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.css" rel="stylesheet">
<script src="https://cdnjs.cloudflare.com/ajax/libs/cropperjs/1.5.12/cropper.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/axios/dist/axios.min.js"></script>

<script>
    var csrfToken = '{{ csrf_token }}';  // CSRF token from Django
    let cropper;
    const imageInput = document.getElementById('imageInput');
    const imagePreview = document.getElementById('imagePreview');
    const croppedImageCanvas = document.getElementById('croppedImageCanvas');
    const croppedImageData = document.getElementById('croppedImageData');
    const uploadForm = document.getElementById('uploadForm');
    const uploadButton = uploadForm.querySelector('button[type="submit"]');
    const cropButton = document.getElementById('cropImageButton');

    // Handle image input change
    imageInput.addEventListener('change', function(event) {
        const file = event.target.files[0];
        if (file) {
            // Validate file type
            if (!file.type.startsWith('image/')) {
                alert('Please upload a valid image file.');
                return;
            }

            const reader = new FileReader();
            reader.onload = function(e) {
                imagePreview.src = e.target.result;
                imagePreview.style.display = 'block'; // Show image preview
                cropButton.style.display = 'block'; // Show crop button
                if (cropper) {
                    cropper.destroy();  // Destroy old cropper instance
                }
                cropper = new Cropper(imagePreview, {
                    aspectRatio: 1,
                    viewMode: 1,
                });
            };
            reader.readAsDataURL(file);
        }
    });

    // Handle cropping and enabling the upload button
    cropButton.addEventListener('click', function() {
        if (cropper) {
            const canvas = cropper.getCroppedCanvas();
            canvas.toBlob(function(blob) {
                const dataURL = canvas.toDataURL('image/png');
                croppedImageData.value = dataURL; // Store data URL in hidden input
                uploadButton.disabled = false; // Enable upload button
                alert('Image cropped successfully! Ready to upload.');
            });
        }
    });

    // Handle form submission
    uploadForm.addEventListener('submit', function(event) {
        event.preventDefault(); // Prevent normal form submission
        if (croppedImageData.value) {
            const formData = new FormData();
            formData.append('croppedImageData', croppedImageData.value);
            formData.append("csrfmiddlewaretoken", csrfToken);

            // Send data using Axios
            axios.post("{% url 'add_images' variant.id %}", formData, {
                headers: {
                    'X-CSRFToken': csrfToken,
                    'Content-Type': 'multipart/form-data'
                }
            }).then(function (response) {
                console.log('Image uploaded successfully:', response.data);
                window.location.href = "{% url 'product_detail' variant.product.id variant.id %}";
            }).catch(function (error) {
                console.error('Error uploading image:', error);
                alert('Error uploading image. Please try again.');
            });
        }
    });
</script>
{% endblock %}
