{% extends "user_home/main.html" %}
{% load static %}

{% block content %}
<section class="shop-details">
    <div class="container">
        <!-- Breadcrumb -->
        <nav aria-label="breadcrumb" class="mb-4">
            <ol class="breadcrumb">
                <li class="breadcrumb-item"><a href="{% url 'user_home' %}">Home</a></li>
                <li class="breadcrumb-item"><a href="{% url 'shop' %}">Shop</a></li>
                <li class="breadcrumb-item active" aria-current="page">Product Details</li>
            </ol>
        </nav>

        <!-- Product Details -->
        <div class="row">
            <div class="col-lg-5 col-md-6 mb-4">
                <!-- Main Image with Custom Zoom -->
                <div class="product__details__pic mb-3" style="position: relative;">
                    <img id="zoom-image" src="{{ product.images.first.image.url }}" 
                         alt="Main Product Image" 
                         class="img-fluid rounded shadow-sm" 
                         style="width: 100%; height: auto; cursor: crosshair;">
                    <!-- Zoomed Image -->
                    <div id="zoomed-image" 
                         style="background-image: url('{{ product.images.first.image.url }}'); 
                                background-repeat: no-repeat; 
                                display: none; 
                                position: absolute; 
                                top: 0; 
                                left: 100%; 
                                transform: translateX(10px); 
                                background-size: 200%; 
                                border: 1px solid #000; 
                                background-color: white; 
                                cursor: zoom-out; 
                                z-index: 10; 
                                width: 400px; 
                                height: 400px;">
                    </div>
                </div>
                <!-- Thumbnails -->
                <div class="product__details__thumbs d-flex justify-content-center flex-wrap">
                    {% for image in product.images.all %}
                    <div class="thumb-item mx-1 mb-2">
                        <a href="javascript:void(0);" class="thumbnail-link" data-image="{{ image.image.url }}">
                            <img src="{{ image.image.url }}" alt="Thumbnail {{ forloop.counter }}" class="img-thumbnail rounded">
                        </a>
                    </div>
                    {% endfor %}
                </div>
            </div>
            
            <div class="col-lg-7 col-md-6">
                <div class="product__details__content">
                    <h4 class="mb-3">{{ product.name }}</h4>

                    <!-- Price and Availability -->
                    <h3 class="mb-3">
                        ₹<span id="product-price">{{ product.main_variant.price }}</span>
                    </h3>

                    <!-- Availability based on stock -->
                    <div id="availability-message">
                        {% if product.stock_quantity == 0 %}
                            <p class="text-danger">Out of Stock</p>
                        {% else %}
                            <p class="text-success">In Stock</p>
                        {% endif %}
                    </div>

                    <!-- Product Variants -->
                    {% if product.variants.all %}
                        <div class="product__variants mb-4">
                            <h5>Variants:</h5>
                            <div class="row">
                                {% for variant in product.variants.all %}
                                    <div class="col-4 mb-2">
                                        <div class="variant-item d-flex align-items-center justify-content-center p-2 border rounded"
                                            style="cursor: pointer;" 
                                            data-price="{{ variant.price }}"
                                            data-stock="{{ variant.stock }}"
                                            data-image="{{ variant.image.url }}">
                                            <!-- Showing the color visually -->
                                            <div class="variant-color" 
                                                style="background-color: {{ variant.color|default:'#FFFFFF' }}; width: 20px; height: 20px; border-radius: 50%;"></div>
                                            <span class="ml-2">{{ variant.name }}</span>
                                        </div>
                                    </div>
                                {% endfor %}
                            </div>
                        </div>
                    {% endif %}

                    <!-- Quantity selection -->
                    {% if product.stock_quantity > 0 %}
                        <div class="product__details__cart__option mb-4">
                            <div class="quantity d-flex align-items-center mb-3">
                                <span class="mr-3">Quantity:</span>
                                <div class="pro-qty">
                                    <input id="quantity-input" type="number" value="1" min="1" max="{{ product.stock_quantity }}">
                                </div>
                            </div>
                            <a href="#" class="btn btn-primary">Add to Cart</a>
                        </div>
                    {% else %}
                        <p class="text-danger">This product is currently out of stock.</p>
                    {% endif %}

                    <!-- Description -->
                    <p class="mb-4">{{ product.description }}</p>

                    <!-- Wishlist and Compare -->
                    <div class="product__details__btns__option mb-4">
                        <a href="#" class="btn btn-outline-primary mr-2"><i class="fa fa-heart"></i> Wishlist</a>
                    </div>
                    <!-- Additional Information -->
                    <div class="product__details__last__option">
                        <h5 class="mb-3">Guaranteed Safe Checkout</h5>
                        <img src="{% static 'img/shop-details/details-payment.png' %}" alt="Payment Methods" class="img-fluid mb-3">
                        <p>Categories: {{ product.category }}</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
</section>

<!-- Related Products -->
<section class="related spad">
    <div class="container">
        <h3 class="related-title mb-4">Related Products</h3>
        <div class="row">
            {% for related_product in related_products %}
            <div class="col-lg-3 col-md-4 col-sm-6 mb-4">
                <a href="{% url 'user_product_detail' related_product.id %}">
                <div class="product__item">
                    <div class="product__item__pic">
                        <img src="{{ related_product.images.first.image.url }}" alt="{{ related_product.name }}" class="img-fluid rounded">
                        {% if related_product.is_new %}
                        <span class="badge badge-success">New</span>
                        {% endif %}
                        <div class="product__hover">
                            <a href="#"><img src="{% static 'img/icon/heart.png' %}" alt="Wishlist"></a>
                            <a href="#"><img src="{% static 'img/icon/compare.png' %}" alt="Compare"></a>
                            <a href="#"><img src="{% static 'img/icon/search.png' %}" alt="Quick View"></a>
                        </div>
                    </div>
                    <div class="product__item__text">
                        <h6>{{ related_product.name }}</h6>
                        <a href="{% url 'product_detail' related_product.id %}" class="btn btn-outline-primary">+ Add To Cart</a>
                        <h5>₹{{ related_product.price }}</h5>
                    </div>
                </div>
            </div>
            {% endfor %}
        </div>
    </div>
</section>

<script type="text/javascript">
    document.addEventListener('DOMContentLoaded', function () {
        const zoomImage = document.getElementById('zoom-image');
        const zoomedImage = document.getElementById('zoomed-image');
        const thumbnailLinks = document.querySelectorAll('.thumbnail-link');

        // Function to update zoom image
        function updateZoomImage(src) {
            zoomImage.src = src;
            zoomedImage.style.backgroundImage = `url(${src})`;
        }

        // Event listener for mouse movement on the zoom image
        zoomImage.addEventListener('mousemove', function (e) {
            const rect = zoomImage.getBoundingClientRect();
            const xPos = e.clientX - rect.left;
            const yPos = e.clientY - rect.top;

            const bgPosX = (xPos / rect.width) * 100;
            const bgPosY = (yPos / rect.height) * 100;

            zoomedImage.style.backgroundPosition = `${bgPosX}% ${bgPosY}%`;
            zoomedImage.style.display = 'block';
        });

        zoomImage.addEventListener('mouseleave', function () {
            zoomedImage.style.display = 'none';
        });

        // Event listener for clicking on thumbnails
        thumbnailLinks.forEach(function (link) {
            link.addEventListener('click', function () {
                const newImageSrc = link.getAttribute('data-image');
                updateZoomImage(newImageSrc);
            });
        });

        // Handle variant selection
        document.querySelectorAll('.variant-item').forEach(function (item) {
            item.addEventListener('click', function () {
                const price = item.getAttribute('data-price');
                const stock = item.getAttribute('data-stock');
                const image = item.getAttribute('data-image');
                
                document.getElementById('product-price').textContent = price;
                document.getElementById('quantity-input').setAttribute('max', stock);
                updateZoomImage(image);

                // Update stock availability message
                const availabilityMessage = document.getElementById('availability-message');
                if (stock == 0) {
                    availabilityMessage.innerHTML = '<p class="text-danger">Out of Stock</p>';
                } else {
                    availabilityMessage.innerHTML = `<p class="text-success">In Stock</p>`;
                }
            });
        });
    });
</script>
{% endblock %}
